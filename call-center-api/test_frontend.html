<!DOCTYPE html>
<html>
<head>
    <title>Call Center Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .call-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .status { font-weight: bold; }
        button { padding: 10px; margin: 5px; }
        #logs { background: #f0f0f0; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>Call Center Test Interface</h1>
    
    <div>
        <input type="text" id="phoneNumber" placeholder="+254112153848" value="+254112153848">
        <button onclick="makeCall()">Make Call</button>
        <button onclick="getActiveCalls()">Refresh Active Calls</button>
    </div>
    
    <h2>Active Calls</h2>
    <div id="activeCalls"></div>
    
    <h2>Logs</h2>
    <div id="logs"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        const WS_BASE = 'ws://localhost:8000/api';
        let token = null;

        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logs.scrollTop = logs.scrollHeight;
        }

        async function login() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    log('Logged in successfully');
                    return true;
                } else {
                    log('Login failed: ' + response.statusText);
                    return false;
                }
            } catch (error) {
                log('Login error: ' + error.message);
                return false;
            }
        }

        async function makeCall() {
            if (!token && !(await login())) return;
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            log(`Initiating call to ${phoneNumber}...`);
            
            try {
                const response = await fetch(`${API_BASE}/calls/initiate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ to: phoneNumber })
                });
                
                if (response.ok) {
                    const call = await response.json();
                    log(`Call initiated: ${call.session_id}`);
                    streamCall(call.session_id);
                    getActiveCalls();
                } else {
                    log('Call failed: ' + response.statusText);
                }
            } catch (error) {
                log('Call error: ' + error.message);
            }
        }

        function streamCall(sessionId) {
            const ws = new WebSocket(`${WS_BASE}/calls/stream/${sessionId}`);
            
            ws.onopen = () => log(`Streaming call ${sessionId}`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`Call update: ${JSON.stringify(data)}`);
                
                if (data.recording_url) {
                    log(`Recording available: ${data.recording_url}`);
                }
                
                getActiveCalls(); // Refresh active calls
            };
            
            ws.onerror = (error) => log(`WebSocket error: ${error}`);
            ws.onclose = () => log(`Stream closed for ${sessionId}`);
        }

        async function getActiveCalls() {
            if (!token && !(await login())) return;
            
            try {
                const response = await fetch(`${API_BASE}/calls/active`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const calls = await response.json();
                    displayActiveCalls(calls);
                } else {
                    log('Failed to get active calls: ' + response.statusText);
                }
            } catch (error) {
                log('Error getting active calls: ' + error.message);
            }
        }

        function displayActiveCalls(calls) {
            const container = document.getElementById('activeCalls');
            container.innerHTML = '';
            
            if (calls.length === 0) {
                container.innerHTML = '<p>No active calls</p>';
                return;
            }
            
            calls.forEach(call => {
                const div = document.createElement('div');
                div.className = 'call-item';
                div.innerHTML = `
                    <div><strong>Session:</strong> ${call.session_id}</div>
                    <div><strong>From:</strong> ${call.from} â†’ <strong>To:</strong> ${call.to}</div>
                    <div class="status"><strong>Status:</strong> ${call.status}</div>
                    <div><strong>Duration:</strong> ${call.duration}s</div>
                    ${call.recording_url ? `<div><strong>Recording:</strong> <a href="${call.recording_url}" target="_blank">Play</a></div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // Auto-login on page load
        window.onload = () => {
            login();
            log('Test interface loaded');
        };
    </script>
</body>
</html>
